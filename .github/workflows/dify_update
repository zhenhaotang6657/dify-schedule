name: Dify 工作流每日定时执行

on:
  # 使用 cron 表达式设置定时触发，北京时间 9:00 = UTC 时间 1:00
  schedule:
    - cron: '0 1 * * *'  # UTC 时间每天凌晨 1 点，即北京时间 9 点

jobs:
  trigger-dify-workflow:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # 设置任务超时时间，避免长时间挂起
    
    steps:
      - name: 触发 Dify 工作流
        run: |
          # 发送 HTTP 请求触发 Dify 工作流
          response=$(curl -s -w "%{http_code}" -X POST \
            "${{ secrets.DIFY_BASE_URL }}/workflow/trigger" \
            -H "Authorization: Bearer ${{ secrets.DIFY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"workflow_id": "${{ secrets.DIFY_WORKFLOW_ID }}", "parameters": {}}' \
            -o response.json)
          
          # 检查响应状态码
          if [ "$response" -eq 200 ]; then
            echo "Dify 工作流触发成功"
            cat response.json
          else
            echo "Dify 工作流触发失败，状态码: $response"
            cat response.json
            exit 1  # 失败时退出，标记任务为失败
          fi
          
        # 设置重试机制，避免网络波动导致的失败
        continue-on-error: false
        retry:
          max-attempts: 3  # 最多重试 3 次
          delay: 10  # 每次重试间隔 10 秒
